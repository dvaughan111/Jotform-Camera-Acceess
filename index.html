<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JotForm Camera Widget</title>
<style>
* { box-sizing: border-box; margin:0; padding:0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background:#f8f9fa; padding:10px; }

.widget-container { width:100%; max-width:500px; margin:0 auto; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.1); }

.state-container { padding:20px; text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:300px; }
.video-container { width:100%; height:300px; background:#000; border-radius:8px; overflow:hidden; position:relative; margin-bottom:20px; }
#video { width:100%; height:100%; object-fit:cover; border-radius:8px; }

.preview-container { width:100%; height:300px; background:#f8f9fa; border-radius:8px; overflow:hidden; margin-bottom:20px; display:flex; align-items:center; justify-content:center; position:relative; }

#preview-image { width:100%; height:100%; object-fit:cover; }

.button-row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px; width:100%; }

.btn { padding:12px 24px; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px; font-weight:600; transition:all 0.2s ease; }
.primary-btn { background:#007bff; }
.primary-btn:hover { background:#0056b3; transform:translateY(-2px); }
.secondary-btn { background:#6c757d; }
.secondary-btn:hover { background:#545b62; transform:translateY(-2px); }

.photo-gallery { margin-top:20px; width:100%; }
.uploaded-photos-list { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; justify-items:center; align-items:center; }
.photo-item { position:relative; cursor:pointer; width:100%; }
.photo-thumbnail { width:100%; height:100%; object-fit:cover; border-radius:8px; }
.photo-delete-btn { position:absolute; top:5px; right:5px; background:#dc3545; color:white; border:none; border-radius:50%; width:28px; height:28px; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:bold; z-index:10; transition:all 0.2s ease; }
.photo-delete-btn:hover { background:#c82333; transform:scale(1.1); }

@media (max-width:600px) { .video-container, .preview-container { height:250px; } .uploaded-photos-list { grid-template-columns:1fr; } }
@media (max-width:400px) { .video-container, .preview-container { height:200px; } .btn { padding:10px 18px; font-size:14px; } .button-row { flex-direction:column; } }
</style>
</head>
<body>
<div id="camera-widget" class="widget-container">
  <div id="initial-state" class="state-container">
    <p>Click the button below to take a picture</p>
    <button id="start-btn" class="btn primary-btn">Take Picture</button>
  </div>

  <div id="camera-state" class="state-container" style="display:none;">
    <div class="video-container">
      <video id="video" playsinline autoplay muted></video>
    </div>
    <div class="button-row">
      <button id="capture-btn" class="btn primary-btn">Capture</button>
      <button id="cancel-btn" class="btn secondary-btn">Cancel</button>
    </div>
  </div>

  <div id="preview-state" class="state-container" style="display:none;">
    <div class="preview-container">
      <img id="preview-image" alt="Captured Image">
    </div>
    <div class="button-row">
      <button id="add-more-btn" class="btn primary-btn" style="display:none;">Add More Images</button>
    </div>
  </div>

  <div id="gallery-state" class="state-container" style="display:none;">
    <div class="photo-gallery">
      <div id="photos-list" class="uploaded-photos-list"></div>
    </div>
  </div>
</div>

<script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
<script>
let currentStream = null;
let capturedPhotos = [];
let currentDataUrl = '';

function showState(state){
  ['initial','camera','preview','gallery'].forEach(s=>{
    const el=document.getElementById(s+'-state');
    if(el) el.style.display='none';
  });
  const current=document.getElementById(state+'-state');
  if(current) current.style.display='flex';
  if(state==='gallery') updateGallery();
}

function startCamera(){
  showState('camera');
  navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}})
    .then(stream=>{
      currentStream=stream;
      const video=document.getElementById('video');
      video.srcObject=stream;
      video.play();
    })
    .catch(err=>{
      alert('Camera access denied or unavailable: '+err.message);
      showState('initial');
    });
}

function stopCamera(){ if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); currentStream=null; } }

function capturePhoto(){
  const video=document.getElementById('video');
  if(video.videoWidth===0||video.videoHeight===0){ alert('Video not ready'); return; }
  const canvas=document.createElement('canvas');
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
  currentDataUrl=canvas.toDataURL('image/jpeg',0.9);
  stopCamera();
  document.getElementById('preview-image').src=currentDataUrl;
  showState('preview');
  uploadPhotoToJotForm(canvas);
}

function uploadPhotoToJotForm(canvas){
  if(typeof JFCustomWidget!=='undefined' && JFCustomWidget.uploadFile){
    canvas.toBlob(blob=>{
      if(!blob) return;
      const fileName='photo_'+Date.now()+'.jpg';
      JFCustomWidget.uploadFile(blob,fileName,(res)=>{
        capturedPhotos.push({filePath:res.filePath, dataUrl:currentDataUrl});
        sendDataToJotForm();
        updateGallery();
        document.getElementById('add-more-btn').style.display='inline-block';
      });
    },'image/jpeg',0.9);
  } else {
    capturedPhotos.push({dataUrl:currentDataUrl});
    updateGallery();
    document.getElementById('add-more-btn').style.display='inline-block';
  }
}

function updateGallery(){
  const list=document.getElementById('photos-list');
  list.innerHTML='';
  if(capturedPhotos.length===0) return;
  capturedPhotos.forEach((photo,index)=>{
    const item=document.createElement('div'); item.className='photo-item';
    const img=document.createElement('img'); img.src=photo.dataUrl; img.className='photo-thumbnail';
    const del=document.createElement('button'); del.className='photo-delete-btn'; del.innerHTML='Ã—';
    del.onclick=e=>{ e.stopPropagation(); capturedPhotos.splice(index,1); updateGallery(); sendDataToJotForm(); };
    item.appendChild(img); item.appendChild(del);
    list.appendChild(item);
  });
  showState('gallery');
}

function sendDataToJotForm(){
  if(typeof JFCustomWidget!=='undefined' && JFCustomWidget.sendData){
    const files=capturedPhotos.map(p=>p.filePath).filter(Boolean);
    JFCustomWidget.sendData({value:files, valid:true});
  }
}

// Button Events
document.getElementById('start-btn').addEventListener('click',startCamera);
document.getElementById('capture-btn').addEventListener('click',capturePhoto);
document.getElementById('cancel-btn').addEventListener('click',()=>{stopCamera(); showState('initial'); });
document.getElementById('add-more-btn').addEventListener('click',()=>{showState('camera'); startCamera(); });

// Initialize Widget
document.addEventListener('DOMContentLoaded',()=>{
  if(typeof JFCustomWidget!=='undefined'){
    JFCustomWidget.subscribe('ready',()=>{ sendDataToJotForm(); });
  }
});
</script>
</body>
</html>
