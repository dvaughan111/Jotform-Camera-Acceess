async function startCamera() {
    showState('camera');
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' }
        });
        currentStream = stream;
        video.srcObject = stream;

        // Wait until video metadata is loaded
        await new Promise((resolve) => {
            video.onloadedmetadata = () => resolve();
        });

        await video.play();
    } catch (err) {
        console.error('Camera error', err);
        alert('Camera not available: ' + err.message);
    }
}

function capturePhoto() {
    if (!video.videoWidth || !video.videoHeight) {
        console.log('Video not ready, retrying...');
        setTimeout(capturePhoto, 100);
        return;
    }

    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Convert to blob and upload
    canvas.toBlob((blob) => {
        if (!blob) {
            console.error('Failed to create blob');
            return;
        }
        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);

        // JotForm upload
        if (typeof JFCustomWidget !== 'undefined') {
            const fileName = 'photo_' + Date.now() + '.jpg';
            JFCustomWidget.uploadFile(blob, fileName, function (response) {
                capturedPhotos.push({ dataUrl, filePath: response.filePath });
                sendDataToJotForm();
                updateGallery();
                showState('gallery');
            });
        }
    }, 'image/jpeg', 0.9);

    stopCamera();
}
