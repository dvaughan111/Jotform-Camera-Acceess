<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JotForm Camera Widget</title>
<style>
body { font-family: Arial,sans-serif; background:#f8f9fa; padding:10px; }
.widget-container { max-width:500px; margin:0 auto; background:#fff; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.1); overflow:hidden; padding:15px; }
.video-container { width:100%; height:300px; background:#000; border-radius:8px; overflow:hidden; margin-bottom:15px; position:relative; }
#video { width:100%; height:100%; object-fit:cover; }
.photo-thumb { width:100%; height:300px; object-fit:cover; border-radius:8px; }
.thumb-wrapper { position:relative; margin-bottom:15px; }
.delete-btn { position:absolute; top:8px; right:8px; background:#dc3545; color:white; border:none; border-radius:50%; width:32px; height:32px; font-size:18px; cursor:pointer; font-weight:bold; display:flex; align-items:center; justify-content:center; z-index:10; }
.delete-btn:hover { background:#c82333; }
.btn { padding:14px 28px; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px; font-weight:600; transition:all .2s ease; margin:8px; background:#007bff; }
.btn:hover { background:#0056b3; transform:translateY(-2px); }
.gallery { display:flex; flex-direction:column; width:100%; }
</style>
</head>
<body>

<div id="camera-widget" class="widget-container">
  <div class="video-container">
    <video id="video" playsinline autoplay muted></video>
  </div>
  <button id="capture-btn" class="btn">Take Picture</button>
  <div id="gallery" class="gallery"></div>
</div>

<script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
<script>
let currentStream = null;
let capturedPhotos = [];

const video = document.getElementById('video');
const captureBtn = document.getElementById('capture-btn');
const galleryDiv = document.getElementById('gallery');

// Start camera
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    currentStream = stream;
    video.srcObject = stream;
    await new Promise(resolve => video.onloadedmetadata = resolve);
    video.play();
  } catch(err) {
    console.error('Camera error', err);
    alert('Camera not available: ' + err.message);
  }
}

// Stop camera
function stopCamera() {
  if(currentStream) { currentStream.getTracks().forEach(t => t.stop()); currentStream = null; }
}

// Update gallery display
function updateGallery() {
  galleryDiv.innerHTML = '';
  capturedPhotos.forEach((photo, index) => {
    const wrapper = document.createElement('div');
    wrapper.className = 'thumb-wrapper';
    const img = document.createElement('img');
    img.src = photo.dataUrl;
    img.className = 'photo-thumb';
    wrapper.appendChild(img);

    const del = document.createElement('button');
    del.className = 'delete-btn';
    del.innerHTML = 'Ã—';
    del.onclick = () => {
      capturedPhotos.splice(index,1);
      sendDataToJotForm();
      updateGallery();
    };
    wrapper.appendChild(del);

    galleryDiv.appendChild(wrapper);
  });
}

// Send data to JotForm for PDF
function sendDataToJotForm() {
  if(typeof JFCustomWidget !== 'undefined' && JFCustomWidget.sendData) {
    // Use original submit-friendly format
    let submissionText = capturedPhotos.map((p,i) => `[Image ${i+1}]`).join(', ');
    JFCustomWidget.sendData({ value: submissionText, valid: true });
  }
}

// Capture photo
function capturePhoto() {
  if(video.videoWidth === 0 || video.videoHeight === 0){
    setTimeout(capturePhoto,100); // wait until video is ready
    return;
  }
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

  const dataUrl = canvas.toDataURL('image/jpeg',0.9);

  if(typeof JFCustomWidget !== 'undefined' && JFCustomWidget.uploadFile) {
    const fileName = 'photo_' + Date.now() + '.jpg';
    canvas.toBlob(blob => {
      if(!blob) return;
      JFCustomWidget.uploadFile(blob, fileName, function(response){
        capturedPhotos.push({ dataUrl, filePath: response.filePath });
        sendDataToJotForm();
        updateGallery();
      });
    }, 'image/jpeg', 0.9);
  } else {
    // fallback for standalone testing
    capturedPhotos.push({ dataUrl });
    updateGallery();
  }
}

captureBtn.addEventListener('click', capturePhoto);

// Initialize camera on widget ready
if(typeof JFCustomWidget !== 'undefined') {
  JFCustomWidget.subscribe('ready', function(){
    startCamera();
    JFCustomWidget.sendData({ value:'', valid:true });
  });
} else {
  startCamera(); // standalone
}
</script>

</body>
</html>
