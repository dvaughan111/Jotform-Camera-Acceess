<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Photo Upload Widget</title>
  <style>
    /* your original CSS here */
    .thumbnail {
      width: 150px;
      height: 150px;
      object-fit: cover;
      margin: 4px;
    }
  </style>
  <!-- Axios for Cloudinary upload -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.7/axios.min.js"></script>
</head>
<body>
  <!-- your original widget layout -->
  <div id="cameraContainer">
    <video id="video" autoplay playsinline></video>
    <canvas id="photoCanvas" style="display:none;"></canvas>
    <button id="takePhoto">Take Photo</button>
    <button id="uploadPhoto">Upload Photo</button>
  </div>

  <div id="thumbnailsContainer"></div>

  <script>
    // === your original JS ===
    const video = document.getElementById('video');
    const photoCanvas = document.getElementById('photoCanvas');
    const takePhotoBtn = document.getElementById('takePhoto');
    const uploadPhotoBtn = document.getElementById('uploadPhoto');
    const thumbnailsContainer = document.getElementById('thumbnailsContainer');

    const uploadedPhotos = [];

    // start camera
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => { video.srcObject = stream; })
      .catch(err => console.error('Error accessing camera: ', err));

    // take photo
    takePhotoBtn.addEventListener('click', () => {
      const context = photoCanvas.getContext('2d');
      photoCanvas.width = video.videoWidth;
      photoCanvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
      photoCanvas.style.display = 'block';
    });

    // upload photo (with Cloudinary)
    uploadPhotoBtn.addEventListener('click', uploadPhoto);

    async function uploadPhoto() {
      const imageData = photoCanvas.toDataURL('image/jpeg');

      // ⬇️ Cloudinary upload block
      const blob = await (await fetch(imageData)).blob();
      const formData = new FormData();
      formData.append('file', blob);
      formData.append('upload_preset', 'YOUR_UNSIGNED_PRESET'); // replace

      try {
        const res = await axios.post(
          'https://api.cloudinary.com/v1_1/YOUR_CLOUD_NAME/image/upload',
          formData
        );

        // push Cloudinary URL instead of base64
        uploadedPhotos.push({
          data: res.data.secure_url, // ✅ HTTPS URL
          name: res.data.original_filename + '.jpg',
          type: 'image/jpeg'
        });

        updateThumbnails();
        updateJotFormField();
      } catch (err) {
        console.error(err);
        alert('Upload failed, please try again.');
      }
    }

    function updateThumbnails() {
      thumbnailsContainer.innerHTML = '';
      uploadedPhotos.forEach(photo => {
        const img = document.createElement('img');
        img.src = photo.data;
        img.className = 'thumbnail';
        thumbnailsContainer.appendChild(img);
      });
    }

    function updateJotFormField() {
      const formattedData = uploadedPhotos.map(photo => ({
        url: photo.data, // now Cloudinary URL
        fileName: photo.name,
        pdfOptions: {
          display: 'thumbnail',
          width: '150px',
          height: '150px',
          alignment: 'center'
        }
      }));

      if (window.JFCustomWidget) {
        JFCustomWidget.sendData({
          value: JSON.stringify(formattedData)
        });
      }
    }
  </script>
</body>
</html>
