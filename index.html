<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Camera Upload Widget</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f9f9f9;
  padding: 20px;
  text-align: center;
}

video, canvas {
  max-width: 100%;
  border-radius: 8px;
}

button {
  background-color: #4c6ef5;
  color: #fff;
  border: none;
  padding: 10px 16px;
  margin: 6px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 15px;
}

button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

#instantUpload {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  margin-top: 15px;
  gap: 8px;
}

.thumb {
  position: relative;
  cursor: pointer;
  transition: transform 0.2s;
}

.thumb:hover {
  transform: scale(1.05);
}

.thumb img {
  width: 120px;
  height: auto;
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.pdf-icon {
  position: absolute;
  top: 5px;
  right: 5px;
  background: rgba(255,0,0,0.7);
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.8);
  align-items: center;
  justify-content: center;
}

.modal-content {
  max-width: 90%;
  max-height: 90%;
  background: white;
  padding: 20px;
  border-radius: 8px;
}

.close {
  position: absolute;
  top: 15px;
  right: 35px;
  color: #f1f1f1;
  font-size: 40px;
  font-weight: bold;
  cursor: pointer;
}

.pdf-viewer {
  width: 80vw;
  height: 80vh;
  border: none;
}

.file-upload {
  margin: 15px 0;
}

.file-upload-label {
  display: inline-block;
  padding: 10px 16px;
  background-color: #4c6ef5;
  color: white;
  border-radius: 6px;
  cursor: pointer;
}
</style>
</head>
<body>

<video id="camera" autoplay playsinline></video><br>
<canvas id="photoCanvas" style="display:none;"></canvas><br>

<button id="startCamera">Start Camera</button>
<button id="capturePhoto" disabled>Capture Photo</button>

<div class="file-upload">
  <label for="pdfUpload" class="file-upload-label">Upload PDF</label>
  <input type="file" id="pdfUpload" accept=".pdf" style="display:none;">
</div>

<div id="instantUpload"></div>

<div id="modal" class="modal">
  <span class="close">&times;</span>
  <div class="modal-content" id="modalContent"></div>
</div>

<script>
// === CONFIG ===
const cloudName = "du0puu5mt";
const uploadPreset = "jotform_widget_upload";

// === Elements ===
const video = document.getElementById('camera');
const canvas = document.getElementById('photoCanvas');
const startCameraBtn = document.getElementById('startCamera');
const capturePhotoBtn = document.getElementById('capturePhoto');
const instantUploadDiv = document.getElementById('instantUpload');
const pdfUpload = document.getElementById('pdfUpload');
const modal = document.getElementById('modal');
const modalContent = document.getElementById('modalContent');
const closeModal = document.querySelector('.close');

let stream;

// Start camera
startCameraBtn.addEventListener('click', async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
    capturePhotoBtn.disabled = false;
  } catch (err) {
    alert('Camera error: ' + err.message);
  }
});

// Capture and upload photo
capturePhotoBtn.addEventListener('click', () => {
  if (!stream) return;

  const ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);

  canvas.toBlob(async (blob) => {
    if (!blob) return;

    const formData = new FormData();
    formData.append('file', blob, 'photo.jpg');
    formData.append('upload_preset', uploadPreset);

    try {
      const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      if (data.secure_url) {
        addThumbnail(data.secure_url, 'image');
      } else {
        console.error('Cloudinary error', data);
        alert('Upload failed.');
      }
    } catch (err) {
      console.error(err);
      alert('Upload error.');
    }
  }, 'image/jpeg');
});

// Handle PDF upload
pdfUpload.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (file && file.type === 'application/pdf') {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', uploadPreset);

    try {
      const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/raw/upload`, {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      if (data.secure_url) {
        // Generate a thumbnail for the PDF
        const pdfThumbnail = await generatePdfThumbnail(file);
        addThumbnail(pdfThumbnail, 'pdf', data.secure_url);
      } else {
        console.error('Cloudinary error', data);
        alert('PDF upload failed.');
      }
    } catch (err) {
      console.error(err);
      alert('PDF upload error.');
    }
  } else {
    alert('Please select a valid PDF file.');
  }
});

// Generate a thumbnail for PDF files
async function generatePdfThumbnail(file) {
  // For a real implementation, you would use a PDF.js to generate a thumbnail
  // For this example, we'll return a generic PDF icon
  return 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTUwIiB2aWV3Qm94PSIwIDAgMTIwIDE1MCI+PHJlY3QgeD0iMTAiIHk9IjEwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEzMCIgZmlsbD0iI2ZmZiIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjIiLz48dGV4dCB4PSIyMCIgeT0iNDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzMzMyI+UERGIEZJTEU8L3RleHQ+PHRleHQgeD0iMjAiIHk9IjcwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiMzMzMiPkNsaWNrIHRvPC90ZXh0Pjx0ZXh0IHg9IjIwIiB5PSI5MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjMzMzIj52aWV3PC90ZXh0Pjwvc3ZnPg==';
}

function addThumbnail(thumbnailUrl, type, pdfUrl = null) {
  const thumb = document.createElement('div');
  thumb.className = 'thumb';
  
  if (type === 'pdf') {
    thumb.innerHTML = `
      <img src="${thumbnailUrl}" alt="pdf thumbnail">
      <div class="pdf-icon">PDF</div>
    `;
    thumb.dataset.pdfUrl = pdfUrl;
  } else {
    thumb.innerHTML = `<img src="${thumbnailUrl}" alt="photo">`;
  }
  
  thumb.addEventListener('click', () => {
    if (type === 'pdf') {
      modalContent.innerHTML = `
        <embed class="pdf-viewer" src="${pdfUrl}" type="application/pdf">
      `;
    } else {
      modalContent.innerHTML = `<img src="${thumbnailUrl}" style="max-width: 100%;">`;
    }
    modal.style.display = 'flex';
  });
  
  instantUploadDiv.appendChild(thumb);
}

// Close modal when clicking on X
closeModal.addEventListener('click', () => {
  modal.style.display = 'none';
});

// Close modal when clicking outside content
modal.addEventListener('click', (e) => {
  if (e.target === modal) {
    modal.style.display = 'none';
  }
});
</script>

</body>
</html>
